# ğŸš€ GPS ê¸°ë°˜ ììœ¨ì£¼í–‰ ì‹œìŠ¤í…œ êµ¬ì¶• ê°€ì´ë“œ

ROS2ì—ì„œ ì •ì  ì§€ë„ì™€ GPSë¥¼ ì´ìš©í•œ ì§€ë¦¬ ì°¸ì¡° ê¸°ë°˜ ììœ¨ ì£¼í–‰ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ëŠ” ì™„ì „í•œ ê°€ì´ë“œì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [í•„ìˆ˜ ì¡°ê±´](#í•„ìˆ˜-ì¡°ê±´)
3. [ë¹ ë¥¸ ì‹œì‘](#ë¹ ë¥¸-ì‹œì‘)
4. [ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ](#ì‹œìŠ¤í…œ-êµ¬ì„±-ìš”ì†Œ)
5. [GPS ì§€ë„ ë³´ì • ë°©ë²•](#gps-ì§€ë„-ë³´ì •-ë°©ë²•)
6. [ë¬¸ì œ í•´ê²°](#ë¬¸ì œ-í•´ê²°)
7. [ê³ ê¸‰ ì„¤ì •](#ê³ ê¸‰-ì„¤ì •)

## ğŸ¯ ì‹œìŠ¤í…œ ê°œìš”

ì´ ì‹œìŠ¤í…œì€ ë‹¤ìŒê³¼ ê°™ì€ ê³„ì¸µì  êµ¬ì¡°ë¡œ GPS ê¸°ë°˜ ììœ¨ì£¼í–‰ì„ êµ¬í˜„í•©ë‹ˆë‹¤:

```
ì§€êµ¬(Earth) â†’ UTM â†’ MAP â†’ ODOM â†’ BASE_LINK
```

### í•µì‹¬ ê¸°ëŠ¥
- âœ… **ì •ì  ì§€ë„ì™€ GPS ì¢Œí‘œ ì •ë ¬**: í•­ê³µì‚¬ì§„ì´ë‚˜ ì§€ë„ ì´ë¯¸ì§€ë¥¼ ì‹¤ì œ ì§€ë¦¬ ì¢Œí‘œì— ì •í™•íˆ ë§¤í•‘
- âœ… **ì´ì¤‘ EKF ì•„í‚¤í…ì²˜**: ì§€ì—­/ì „ì—­ ìœ„ì¹˜ ì¶”ì •ì„ í†µí•œ ê°•ë ¥í•œ ì„¼ì„œ ìœµí•©
- âœ… **ë“œë¦¬í”„íŠ¸ ì—†ëŠ” ì „ì—­ ì¸¡ìœ„**: GPS ê¸°ë°˜ìœ¼ë¡œ ëˆ„ì  ì˜¤ì°¨ ì—†ëŠ” ì¥ê±°ë¦¬ í•­ë²•
- âœ… **ëŒ€í™”í˜• ë³´ì • ì‹œìŠ¤í…œ**: RViz í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ì§€ë„-GPS ì •ë ¬
- âœ… **Nav2 í˜¸í™˜ì„±**: í‘œì¤€ ROS2 í•­ë²• ìŠ¤íƒê³¼ ì™„ë²½ í†µí•©

## ğŸ”§ í•„ìˆ˜ ì¡°ê±´

### í•˜ë“œì›¨ì–´ ìš”êµ¬ì‚¬í•­
- **GPS ìˆ˜ì‹ ê¸°**: RTK-GPS ê¶Œì¥ (ì •í™•ë„ í–¥ìƒ)
- **IMU ì„¼ì„œ**: 9ì¶• IMU (ìì´ë¡œìŠ¤ì½”í”„, ê°€ì†ë„ê³„, ì§€ìê¸°ì„¼ì„œ)
- **íœ  ì—”ì½”ë”**: ì˜¤ë„ë©”íŠ¸ë¦¬ ì œê³µ
- **ì»´í“¨í„°**: ROS2 ì‹¤í–‰ ê°€ëŠ¥í•œ ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œ

### ì†Œí”„íŠ¸ì›¨ì–´ ìš”êµ¬ì‚¬í•­
- **ROS2** (Humble/Foxy)
- **robot_localization** íŒ¨í‚¤ì§€
- **Nav2** ìŠ¤íƒ
- **Python 3** + í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬

### ì„¤ì¹˜ ëª…ë ¹ì–´
```bash
# ROS2 íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt update
sudo apt install ros-$ROS_DISTRO-robot-localization \
                 ros-$ROS_DISTRO-nav2-map-server \
                 ros-$ROS_DISTRO-nav2-lifecycle-manager \
                 ros-$ROS_DISTRO-tf2-tools \
                 ros-$ROS_DISTRO-rviz2

# Python ì˜ì¡´ì„±
pip3 install pyproj pyyaml
```

## âš¡ ë¹ ë¥¸ ì‹œì‘

### 1ë‹¨ê³„: ì§€ë„ ì¤€ë¹„

ë¨¼ì € ì§€ë„ ì´ë¯¸ì§€(.jpg, .png)ë¥¼ ROS í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤:

```bash
# ì´ë¯¸ì§€ë¥¼ .pgm í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (GIMP ë“± ì‚¬ìš©)
# í°ìƒ‰=ììœ ê³µê°„, ê²€ì€ìƒ‰=ì¥ì• ë¬¼

# map.yaml íŒŒì¼ ìƒì„± ì˜ˆì‹œ:
cat > my_map.yaml << EOF
image: my_map.pgm
resolution: 0.05    # í”½ì…€ë‹¹ ë¯¸í„° (ì •í™•íˆ ê³„ì‚° í•„ìš”!)
origin: [0.0, 0.0, 0.0]
negate: 0
occupied_thresh: 0.65
free_thresh: 0.25
EOF
```

### 2ë‹¨ê³„: ì„¼ì„œ í™•ì¸

í•„ìˆ˜ í† í”½ë“¤ì´ ë°œí–‰ë˜ëŠ”ì§€ í™•ì¸:

```bash
# GPS í† í”½ í™•ì¸
ros2 topic echo /gps/fix

# IMU í† í”½ í™•ì¸  
ros2 topic echo /imu/data

# ì˜¤ë„ë©”íŠ¸ë¦¬ í† í”½ í™•ì¸
ros2 topic echo /odom
```

### 3ë‹¨ê³„: ì‹œìŠ¤í…œ ì‹œì‘

```bash
# ë¹ ë¥¸ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
./scripts/quick_start_gps_system.sh /path/to/your/map.yaml
```

### 4ë‹¨ê³„: GPS ì§€ë„ ë³´ì •

1. **RViz ì„¤ì •**:
   - Fixed Frameì„ `map`ìœ¼ë¡œ ì„¤ì •
   - Map Display ì¶”ê°€í•˜ì—¬ ì§€ë„ í™•ì¸

2. **ë³´ì • ì‹¤í–‰**:
   - GPS ì‹ í˜¸ ìˆ˜ì‹  ëŒ€ê¸° (í„°ë¯¸ë„ì—ì„œ í™•ì¸)
   - RVizì˜ "Publish Point" ë„êµ¬ ì„ íƒ
   - ì§€ë„ ìœ„ì—ì„œ í˜„ì¬ ë¡œë´‡ ìœ„ì¹˜ì— í•´ë‹¹í•˜ëŠ” ì§€ì  í´ë¦­

3. **ë³´ì • ì™„ë£Œ**:
   - í„°ë¯¸ë„ì— "âœ… UTM -> MAP ì •ì  ë³€í™˜ ë°œí–‰ ì™„ë£Œ!" ë©”ì‹œì§€ í™•ì¸
   - ì§€ë„ê°€ GPS ì¢Œí‘œì— ì •ë ¬ë¨

## ğŸ”¬ ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ

### 1. ì§€ì—­ EKF (`ekf_local.yaml`)
- **ì—­í• **: ì—°ì†ì ì¸ ì„¼ì„œ ë°ì´í„° ìœµí•©
- **ì…ë ¥**: íœ  ì˜¤ë„ë©”íŠ¸ë¦¬ + IMU ê°ì†ë„/ê°€ì†ë„
- **ì¶œë ¥**: `odom` â†’ `base_link` ë³€í™˜
- **íŠ¹ì„±**: ë†’ì€ ì£¼íŒŒìˆ˜, ë¶€ë“œëŸ½ì§€ë§Œ ë“œë¦¬í”„íŠ¸ ë°œìƒ

### 2. ì „ì—­ EKF (`ekf_global.yaml`)  
- **ì—­í• **: ì „ì—­ ìœ„ì¹˜ ì¶”ì • ë° ë“œë¦¬í”„íŠ¸ ë³´ì •
- **ì…ë ¥**: ì§€ì—­ ì˜¤ë„ë©”íŠ¸ë¦¬ + GPS ë³€í™˜ ì˜¤ë„ë©”íŠ¸ë¦¬ + IMU ë°©ìœ„ê°
- **ì¶œë ¥**: `map` â†’ `odom` ë³€í™˜
- **íŠ¹ì„±**: ì¤‘ê°„ ì£¼íŒŒìˆ˜, ë“œë¦¬í”„íŠ¸ ì—†ìŒ

### 3. NavSat Transform (`navsat_transform.yaml`)
- **ì—­í• **: GPS ì¢Œí‘œë¥¼ ROS ì¢Œí‘œê³„ë¡œ ë³€í™˜
- **ì…ë ¥**: GPS fix + IMU ë°©ìœ„ê° + ì§€ì—­ ì˜¤ë„ë©”íŠ¸ë¦¬
- **ì¶œë ¥**: GPS ê¸°ë°˜ ì˜¤ë„ë©”íŠ¸ë¦¬ ë©”ì‹œì§€
- **íŠ¹ì„±**: UTM íˆ¬ì˜ë²• ì‚¬ìš©

### 4. GPS ì§€ë„ ë³´ì • ë…¸ë“œ (`map_ros.py`)
- **ì—­í• **: ì§€ë„ ì´ë¯¸ì§€ë¥¼ GPS ì¢Œí‘œì— ì •ë ¬
- **ì…ë ¥**: RViz í´ë¦­ ì§€ì  + í˜„ì¬ GPS ìœ„ì¹˜
- **ì¶œë ¥**: `utm` â†’ `map` ì •ì  ë³€í™˜
- **íŠ¹ì„±**: ì¼íšŒì„± ë³´ì •, ì„¤ì •ê°’ ìë™ ì €ì¥

## ğŸ—ºï¸ GPS ì§€ë„ ë³´ì • ë°©ë²•

### ëŒ€í™”í˜• ë³´ì • (ê¶Œì¥)

ì´ ë°©ë²•ì€ í˜„ì¥ì—ì„œ ì§ê´€ì ìœ¼ë¡œ ì§€ë„ë¥¼ GPS ì¢Œí‘œì— ì •ë ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ì¤€ë¹„ ë‹¨ê³„
1. GPS ìˆ˜ì‹ ê¸°ê°€ ì•ˆì •ì ì¸ ì‹ í˜¸ë¥¼ ë°›ê³  ìˆëŠ”ì§€ í™•ì¸
2. ë¡œë´‡ì„ ì§€ë„ìƒì—ì„œ ì‹ë³„ ê°€ëŠ¥í•œ ìœ„ì¹˜ì— ë°°ì¹˜
3. RVizì—ì„œ ì§€ë„ê°€ ì˜¬ë°”ë¥´ê²Œ ë¡œë”©ë˜ì—ˆëŠ”ì§€ í™•ì¸

#### ë³´ì • ì‹¤í–‰
```bash
# ë³´ì • ë…¸ë“œë§Œ ë³„ë„ ì‹¤í–‰ (ì‹œìŠ¤í…œì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)
ros2 run capston_project map_ros.py
```

#### RViz ì„¤ì •
```
Fixed Frame: map
Add â†’ By display type â†’ Map
Topic: /map
```

#### í´ë¦­ ë³´ì •
1. RViz ìƒë‹¨ì˜ "Publish Point" ë²„íŠ¼ í´ë¦­
2. ì§€ë„ìƒì—ì„œ í˜„ì¬ ë¡œë´‡ì´ ìœ„ì¹˜í•œ ì§€ì ì„ í´ë¦­
3. í„°ë¯¸ë„ì—ì„œ ë³´ì • ì™„ë£Œ ë©”ì‹œì§€ í™•ì¸:
   ```
   ğŸ¯ ë³´ì • ì§€ì  ì„ íƒë¨:
      ğŸ“ ì§€ë„ ì¢Œí‘œ: (x=45.123, y=23.456) [m]
      ğŸŒ GPS ì¢Œí‘œ: (ìœ„ë„=37.123456Â°, ê²½ë„=126.987654Â°)
      ğŸ“ UTM ì¢Œí‘œ: (x=323456.789, y=4567890.123) [m]
   âœ… UTM -> MAP ì •ì  ë³€í™˜ ë°œí–‰ ì™„ë£Œ!
   ```

### ì •ì  ë³´ì • (ìë™í™”ëœ í™˜ê²½)

ë°˜ë³µì ì¸ ë°°í¬ë‚˜ ë¬´ì¸ ì‹œìŠ¤í…œì— ì í•©í•©ë‹ˆë‹¤.

#### 1. ê¸°ì¤€ì  ì„¤ì •
ì •í™•í•œ GPS ì¢Œí‘œë¥¼ ì•Œê³  ìˆëŠ” ì§€ë„ìƒì˜ ì§€ì ì„ ì„ íƒí•©ë‹ˆë‹¤.

#### 2. navsat_transform.yaml ìˆ˜ì •
```yaml
navsat_transform:
  ros__parameters:
    wait_for_datum: true
    # ê¸°ì¤€ì  ì •ë³´ëŠ” ëŸ°ì¹˜ íŒŒì¼ì—ì„œ ì œê³µ
```

#### 3. ëŸ°ì¹˜ íŒŒì¼ì— datum ì¶”ê°€
```python
navsat_transform_node = Node(
    # ... ê¸°ì¡´ ì„¤ì • ...
    parameters=[
        # ... ê¸°ì¡´ íŒŒë¼ë¯¸í„° ...
        {
            'datum': [37.123456, 126.987654, 0.0, 'map', 'base_link']
            # [ìœ„ë„, ê²½ë„, ë°©ìœ„ê°, map_frame_id, base_link_frame_id]
        }
    ]
)
```

## ğŸ”§ ë¬¸ì œ í•´ê²°

### GPS ì‹ í˜¸ ë¬¸ì œ

**ì¦ìƒ**: GPS í† í”½ì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í’ˆì§ˆì´ ë‚®ìŒ
```bash
# GPS ìƒíƒœ í™•ì¸
ros2 topic echo /gps/fix --once

# ì •ìƒì ì¸ ì¶œë ¥ ì˜ˆì‹œ:
# status: 
#   status: 0  # 0=ì •ìƒ, -1=ì‹ í˜¸ì—†ìŒ
# latitude: 37.123456
# longitude: 126.987654
```

**í•´ê²°ë°©ë²•**:
- ì•¼ì™¸ ê°œë°©ëœ ì¥ì†Œë¡œ ì´ë™
- GPS ì•ˆí…Œë‚˜ ìœ„ì¹˜ ì¡°ì •
- RTK-GPS ì‚¬ìš© ì‹œ Base Station ì—°ê²° í™•ì¸

### TF ë³€í™˜ ë¬¸ì œ

**ì¦ìƒ**: "Transform timeout" ë˜ëŠ” "Could not transform" ì—ëŸ¬

```bash
# TF íŠ¸ë¦¬ ìƒíƒœ í™•ì¸
ros2 run tf2_tools view_frames

# TF ë³€í™˜ í™•ì¸
ros2 run tf2_ros tf2_echo utm map
ros2 run tf2_ros tf2_echo map odom
ros2 run tf2_ros tf2_echo odom base_link
```

**í•´ê²°ë°©ë²•**:
- ê° EKF ë…¸ë“œê°€ ì •ìƒ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸
- ì„¼ì„œ í† í”½ë“¤ì´ ì˜¬ë°”ë¥¸ frame_idë¥¼ ê°–ëŠ”ì§€ í™•ì¸
- ì„¤ì • íŒŒì¼ì˜ frame ì´ë¦„ ì¼ì¹˜ì„± ì ê²€

### ì§€ë„ í•´ìƒë„ ë¬¸ì œ

**ì¦ìƒ**: ë¡œë´‡ì´ ëª©í‘œ ì§€ì ì„ ì§€ë‚˜ì¹˜ê±°ë‚˜ ëª» ë¯¸ì¹˜ëŠ” í˜„ìƒ

**í•´ê²°ë°©ë²•**:
1. ì§€ë„ì—ì„œ ì•Œë ¤ì§„ ê±°ë¦¬ ì¸¡ì • (ì˜ˆ: ê±´ë¬¼ í­ 20m)
2. ì´ë¯¸ì§€ì—ì„œ í•´ë‹¹ êµ¬ê°„ì˜ í”½ì…€ ìˆ˜ ì¸¡ì • (ì˜ˆ: 400px)
3. í•´ìƒë„ ê³„ì‚°: 20m Ã· 400px = 0.05 m/pixel
4. map.yamlì˜ resolution ê°’ ìˆ˜ì •

### IMU ë°©ìœ„ê° ë¬¸ì œ

**ì¦ìƒ**: ë¡œë´‡ì´ ì˜ëª»ëœ ë°©í–¥ìœ¼ë¡œ íšŒì „í•˜ê±°ë‚˜ GPS ìœµí•©ì´ ë¶ˆì•ˆì •

**í™•ì¸ ë°©ë²•**:
```bash
# IMU ë°ì´í„° í™•ì¸
ros2 topic echo /imu/data --once
```

**í•´ê²°ë°©ë²•**:
- `navsat_transform.yaml`ì˜ `yaw_offset` ì¡°ì •
- ìê¸° í¸ê°(magnetic declination) ì„¤ì • í™•ì¸
- IMU ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìˆ˜í–‰

## âš™ï¸ ê³ ê¸‰ ì„¤ì •

### ì„¼ì„œ ë…¸ì´ì¦ˆ íŠœë‹

EKF ì„¤ì • íŒŒì¼ì—ì„œ ê° ì„¼ì„œì˜ ì‹ ë¢°ë„ë¥¼ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```yaml
# ë†’ì€ ê°’ = ë‚®ì€ ì‹ ë¢°ë„, ë‚®ì€ ê°’ = ë†’ì€ ì‹ ë¢°ë„
process_noise_covariance: [
  0.05, 0, 0, ...  # X ìœ„ì¹˜ ë…¸ì´ì¦ˆ
  0, 0.05, 0, ...  # Y ìœ„ì¹˜ ë…¸ì´ì¦ˆ
  # ... 15x15 í–‰ë ¬ ...
]
```

### ë‹¤ì¤‘ GPS ì•ˆí…Œë‚˜

ì—¬ëŸ¬ GPS ì•ˆí…Œë‚˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°:

```yaml
# ekf_global.yamlì— ì¶”ê°€
odom2: /gps/fix2_transformed
odom2_config: [true, true, false, ...]
```

### ì‹¤ì‹œê°„ ì„±ëŠ¥ ìµœì í™”

```yaml
# ì‹¤ì‹œê°„ ì‹œìŠ¤í…œìš© ì„¤ì •
ekf_filter_node:
  ros__parameters:
    frequency: 50.0  # ë†’ì€ ì£¼íŒŒìˆ˜
    predict_to_current_time: true
    publish_acceleration: false  # ë¶ˆí•„ìš”í•œ ì—°ì‚° ì œê±°
```

## ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸

```bash
# ìœ„ì¹˜ ì¶”ì • ì •í™•ë„ ëª¨ë‹ˆí„°ë§
ros2 topic echo /diagnostics

# ê° EKF ë…¸ë“œ ìƒíƒœ
ros2 node info /ekf_filter_local
ros2 node info /ekf_filter_global

# GPS í’ˆì§ˆ í™•ì¸
ros2 topic echo /gps/fix | grep -A3 "status"
```

### ë¡œê·¸ ë¶„ì„

```bash
# ROS ë¡œê·¸ ìœ„ì¹˜
cd ~/.ros/log/

# GPS ë³€í™˜ ì •í™•ë„ ë¶„ì„
ros2 topic echo /gps/filtered > gps_filtered.log
ros2 topic echo /gps/fix > gps_raw.log
```

## ğŸš€ Nav2ì™€ í†µí•©

ì§€ë„ ë³´ì •ì´ ì™„ë£Œë˜ë©´ Nav2ë¥¼ ì‚¬ìš©í•˜ì—¬ ì™„ì „í•œ ììœ¨ì£¼í–‰ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash
# AMCL ì—†ì´ Nav2 ì‹¤í–‰
ros2 launch nav2_bringup navigation_launch.py \
    use_sim_time:=false \
    params_file:=./config/nav2_params.yaml
```

**ì£¼ì˜ì‚¬í•­**: AMCLì„ ë¹„í™œì„±í™”í•˜ê³  ìš°ë¦¬ì˜ EKF ì‹œìŠ¤í…œì´ `map` â†’ `odom` ë³€í™˜ì„ ì œê³µí•˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.

## ğŸ“š ì°¸ê³  ìë£Œ

- [ROS2 robot_localization ë¬¸ì„œ](http://docs.ros.org/en/melodic/api/robot_localization/html/)
- [Nav2 GPS íŠœí† ë¦¬ì–¼](https://docs.nav2.org/tutorials/docs/navigation2_with_gps.html)
- [REP-105: ì¢Œí‘œê³„ í‘œì¤€](https://www.ros.org/reps/rep-0105.html)

## ğŸ¤ ê¸°ì—¬í•˜ê¸°

ì´ í”„ë¡œì íŠ¸ì— ê¸°ì—¬í•˜ê³  ì‹¶ë‹¤ë©´:
1. ì´ìŠˆ ë³´ê³ : [GitHub Issues](https://github.com/limchanggeon/ros2-delivery-robot/issues)
2. í’€ ë¦¬í€˜ìŠ¤íŠ¸ í™˜ì˜
3. ë¬¸ì„œ ê°œì„  ì œì•ˆ

---

**âš¡ ë¹ ë¥¸ ë„ì›€ë§**: ë¬¸ì œê°€ ë°œìƒí•˜ë©´ `./scripts/quick_start_gps_system.sh --help` ì‹¤í–‰ ë˜ëŠ” ì´ ë¬¸ì„œì˜ ë¬¸ì œ í•´ê²° ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”!